#!/bin/bash

# ==============================================================================
# Script Name: judge_core.sh
# Description: Verilog μ½”λ“μ™€ Testbenchλ¥Ό μ»΄νμΌν•κ³  μ‹λ®¬λ μ΄μ…ν•μ—¬ λ¬΄κ²°μ„±μ„ κ²€μ¦ν•¨.
# Usage: ./judge_core.sh <design_file.v> <testbench_file.v>
# Return: 0 (PASS), 1 (COMPILE ERROR), 2 (SIMULATION FAIL)
# ==============================================================================

# 1. μΈμ ν™•μΈ
if [ "$#" -ne 2 ]; then
    echo "[System] Usage: $0 <design_file.v> <testbench_file.v>"
    exit 1
fi

DESIGN_FILE=$1
TB_FILE=$2
OUTPUT_BIN="sim_output.vvp"
LOG_FILE="sim_log.txt"

# 2. Icarus Verilog μ„¤μΉ ν™•μΈ
if ! command -v iverilog &> /dev/null; then
    echo "[System] Error: iverilog could not be found. Please install it (sudo apt install iverilog)."
    exit 1
fi

echo "========================================="
echo "[System] Starting Verification Process..."
echo "[Input] Design: $DESIGN_FILE"
echo "[Input] Testbench: $TB_FILE"

# 3. μ»΄νμΌ (Compilation)
# -o: μ¶λ ¥ νμΌ μ΄λ¦„
echo "[Step 1] Compiling..."
iverilog -o $OUTPUT_BIN $DESIGN_FILE $TB_FILE 2> compile_error.log

if [ $? -ne 0 ]; then
    echo "[Result] β Compilation FAILED."
    cat compile_error.log
    rm -f compile_error.log
    exit 1 # Return Code 1: Compile Error
fi

echo "[Result] β… Compilation SUCCESS."

# 4. μ‹λ®¬λ μ΄μ… (Simulation)
echo "[Step 2] Running Simulation..."
vvp $OUTPUT_BIN > $LOG_FILE

# 5. κ²°κ³Ό νμ • (Judgment)
# Testbench λ‚΄λ¶€μ— $display("TEST PASSED") νΉμ€ "TEST FAILED"κ°€ μλ‹¤κ³  κ°€μ •.
# μ‚¬μ©μμ λ…Έν•μ°: Testbench μ‘μ„± μ‹ νΉμ • ν‚¤μ›λ“λ¥Ό μ¶λ ¥ν•κ² ν”„λ΅¬ν”„ν… ν•΄μ•Ό ν•¨.

if grep -q "TEST PASSED" $LOG_FILE; then
    echo "[Result] π‰ Verification PASSED!"
    echo "========================================="
    # μ •λ¦¬
    rm -f $OUTPUT_BIN compile_error.log
    exit 0
else
    echo "[Result] β Verification FAILED (Runtime Error or Logic Error)."
    echo "--- Simulation Log ---"
    cat $LOG_FILE
    echo "----------------------"
    # μ •λ¦¬
    rm -f $OUTPUT_BIN compile_error.log
    exit 2 # Return Code 2: Simulation Failed
fi
